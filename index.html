<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H3 Index Visualizer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- H3-js v4.1.0 -->
    <script src="https://unpkg.com/h3-js@4.1.0/dist/h3-js.umd.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .leaflet-layer { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        .leaflet-container { background: #1e293b; cursor: crosshair; }
        /* Custom Scrollbar for Parents list */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Tab Transition */
        .tab-btn { transition: all 0.2s ease-in-out; }
        .tab-active { background-color: #2563eb; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .tab-inactive { background-color: transparent; color: #94a3b8; }
        .tab-inactive:hover { color: white; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 font-sans h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="bg-slate-800 p-4 shadow-lg border-b border-slate-700 flex justify-between items-center z-20">
        <div class="flex items-center gap-2">
            <i data-lucide="layers" class="text-blue-400"></i>
            <h1 class="text-xl font-bold text-white">H3 Index Visualizer</h1>
        </div>
        <div class="text-xs text-slate-400 hidden sm:block">Architecture Validation Tool</div>
    </header>

    <div class="flex flex-col md:flex-row flex-1 overflow-hidden relative">
        
        <!-- SIDEBAR -->
        <div class="w-full md:w-96 bg-slate-800/90 backdrop-blur-sm p-6 flex flex-col gap-6 border-r border-slate-700 z-10 overflow-y-auto h-1/3 md:h-full shadow-xl custom-scroll flex-shrink-0">
            
            <!-- SEARCH CONTROLS -->
            <div class="space-y-4">
                
                <!-- MODE TABS -->
                <div class="flex bg-slate-900 p-1 rounded-lg border border-slate-700">
                    <button id="tabId" class="tab-btn tab-active flex-1 py-1.5 text-xs font-medium rounded-md flex justify-center items-center gap-2">
                        <i data-lucide="hash" class="w-3 h-3"></i> By ID
                    </button>
                    <button id="tabCoord" class="tab-btn tab-inactive flex-1 py-1.5 text-xs font-medium rounded-md flex justify-center items-center gap-2">
                        <i data-lucide="map-pin" class="w-3 h-3"></i> By Lat/Lon
                    </button>
                </div>

                <!-- ID INPUT MODE -->
                <div id="inputModeId" class="space-y-3">
                    <div class="flex justify-between items-end">
                        <label class="text-sm font-medium text-slate-300">H3 ID (Hex or Long)</label>
                        <span class="text-[10px] text-slate-500 bg-slate-800 px-2 py-1 rounded border border-slate-700">
                            Auto-detects Resolution
                        </span>
                    </div>
                    
                    <div class="relative">
                        <input type="text" id="h3Input" placeholder="Ex: 8928308280fffff or 6177..." value="617700169546072063"
                            class="w-full bg-slate-900 border border-slate-600 rounded-lg py-3 pl-4 pr-12 text-white focus:ring-2 focus:ring-blue-500 font-mono text-sm shadow-inner transition-all">
                        
                        <button id="searchBtn" class="absolute right-2 top-2 p-1.5 bg-blue-600 hover:bg-blue-500 rounded-md transition-colors shadow-lg">
                            <i data-lucide="search" class="text-white w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <!-- LAT/LON INPUT MODE -->
                <div id="inputModeCoord" class="space-y-3 hidden">
                    <div class="flex justify-between items-end">
                        <label class="text-sm font-medium text-slate-300">Coordinates</label>
                        <span class="text-[10px] text-slate-500 bg-slate-800 px-2 py-1 rounded border border-slate-700">
                            Calculates Res 10 (Detail)
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] text-slate-400 uppercase font-bold pl-1">Latitude</label>
                            <input type="text" id="latInput" placeholder="41.0082" 
                                class="w-full bg-slate-900 border border-slate-600 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-blue-500 font-mono text-sm">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-slate-400 uppercase font-bold pl-1">Longitude</label>
                            <input type="text" id="lonInput" placeholder="28.9784" 
                                class="w-full bg-slate-900 border border-slate-600 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-blue-500 font-mono text-sm">
                        </div>
                    </div>

                    <button id="searchCoordBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium py-2 rounded-lg transition-colors shadow-lg flex justify-center items-center gap-2 text-sm">
                        <i data-lucide="search" class="w-4 h-4"></i> Find H3 Cell
                    </button>
                </div>

                <!-- Action Row -->
                <div class="flex justify-between items-center pt-2">
                    <span class="text-[10px] text-slate-500 italic flex items-center gap-1">
                        <i data-lucide="mouse-pointer-2" class="w-3 h-3"></i> Click map to pick cell
                    </span>
                    <button id="locateBtn" class="text-xs flex items-center gap-1 bg-slate-800 hover:bg-slate-700 text-blue-400 px-3 py-1.5 rounded border border-slate-700 transition-colors shadow-sm" title="Find my location using selected resolution">
                        <i data-lucide="crosshair" class="w-3 h-3"></i> Locate Me
                    </button>
                </div>
            </div>

            <!-- Error Box -->
            <div id="errorBox" class="hidden bg-red-500/10 border border-red-500/50 rounded-lg p-3 flex flex-col gap-2 animate-pulse">
                <div class="flex items-center gap-2 text-red-400 font-bold text-sm">
                    <i data-lucide="alert-circle" class="w-5 h-5"></i> Error
                </div>
                <p id="errorText" class="text-sm text-red-200"></p>
                <div class="w-full mt-2 pt-2 border-t border-red-500/30 text-xs text-white bg-red-900/50 p-1 rounded font-mono break-all" id="errorHex"></div>
            </div>

            <!-- Info Panel -->
            <div id="infoPanel" class="hidden flex flex-col gap-4">
                
                <!-- Main Details Card -->
                <div class="bg-slate-900 rounded-xl border border-slate-700 overflow-hidden shadow-lg">
                    <div class="bg-slate-800 px-4 py-2 border-b border-slate-700 font-semibold text-sm flex justify-between items-center text-slate-200">
                        <span class="flex items-center gap-2"><i data-lucide="info" class="text-blue-400 w-4 h-4"></i> Cell Details</span>
                    </div>
                    
                    <div class="p-4 space-y-4">
                        <div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 font-bold">Hex ID</div>
                            <div id="displayHex" class="font-mono text-green-400 text-lg break-all leading-tight"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 font-bold">Resolution</div>
                                <span id="displayRes" class="bg-blue-600/20 text-blue-300 px-2 py-0.5 rounded text-xs border border-blue-600/30 font-mono"></span>
                            </div>
                            <div>
                                <div class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 font-bold">Area (Approx)</div>
                                <div id="displayArea" class="text-slate-300 text-sm font-mono"></div>
                            </div>
                        </div>

                        <div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 font-bold">Center Coordinates</div>
                            <div id="displayCenter" class="font-mono text-xs text-slate-400 bg-slate-800/50 p-2 rounded border border-slate-700/50"></div>
                            
                            <button id="swapBtn" class="mt-3 w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded text-[10px] transition-colors border border-slate-700">
                                <i data-lucide="arrow-left-right" class="w-3 h-3"></i>
                                Swap Lat/Lon (Debug)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Parents List -->
                <div class="bg-slate-900 rounded-xl border border-slate-700 overflow-hidden shadow-lg">
                    <div class="bg-slate-800 px-4 py-2 border-b border-slate-700 font-semibold text-sm flex justify-between items-center text-slate-200">
                        <span class="flex items-center gap-2"><i data-lucide="arrow-up-circle" class="text-purple-400 w-4 h-4"></i> Parents (Zoom Out)</span>
                    </div>
                    <div class="max-h-48 overflow-y-auto custom-scroll p-2 space-y-1" id="parentsList">
                        <!-- Parent items will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Footer Area -->
            <div class="mt-auto pt-4 border-t border-slate-700 space-y-3">
                <button id="statsBtn" class="w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded text-xs transition-colors border border-slate-700 shadow-sm hover:shadow-md hover:border-slate-600">
                    <i data-lucide="table" class="w-3 h-3"></i> H3 Reference Table
                </button>
                
                <div class="text-center">
                    <a href="https://h3geo.org/docs/" target="_blank" class="text-[10px] text-blue-400 hover:text-blue-300 transition-colors flex items-center justify-center gap-1">
                        <i data-lucide="external-link" class="w-3 h-3"></i> H3 Official Documentation
                    </a>
                </div>
            </div>
        </div>

        <!-- MAP -->
        <div id="map" class="flex-1 h-2/3 md:h-full bg-slate-900 z-0"></div>
    </div>

    <!-- STATS MODAL -->
    <div id="statsModal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-4xl max-h-[90vh] rounded-xl border border-slate-700 shadow-2xl flex flex-col animate-in fade-in zoom-in duration-200">
            <!-- Modal Header -->
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800 rounded-t-xl">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <i data-lucide="table" class="text-blue-400"></i> H3 Resolution Statistics
                </h2>
                <button id="closeStatsBtn" class="text-slate-400 hover:text-white hover:bg-slate-700 p-1 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Modal Body (Table) -->
            <div class="overflow-auto p-0 custom-scroll">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-800/50 sticky top-0 z-10">
                        <tr class="text-xs text-slate-400 uppercase border-b border-slate-700">
                            <th class="p-3 font-semibold whitespace-nowrap">Res</th>
                            <th class="p-3 font-semibold">Total Hexagons</th>
                            <th class="p-3 font-semibold">Edge Length</th>
                            <th class="p-3 font-semibold">Avg Diameter (Span)</th>
                            <th class="p-3 font-semibold">Avg Area</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody" class="text-sm text-slate-300 font-mono divide-y divide-slate-800">
                        <!-- JS generated rows -->
                    </tbody>
                </table>
            </div>
            
            <!-- Modal Footer -->
            <div class="p-3 border-t border-slate-700 bg-slate-800/50 text-[10px] text-slate-500 text-center rounded-b-xl">
                Values are approximate averages based on H3 documentation.
            </div>
        </div>
    </div>

    <script>
        // Safe Icon Refresher
        const refreshIcons = () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        // Initial icon load
        refreshIcons();

        const map = L.map('map').setView([41.0082, 28.9784], 12);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap, © CARTO', subdomains: 'abcd', maxZoom: 20
        }).addTo(map);

        const layerGroup = L.layerGroup().addTo(map);
        
        // Element References
        const els = {
            // TABS
            tabId: document.getElementById('tabId'),
            tabCoord: document.getElementById('tabCoord'),
            inputModeId: document.getElementById('inputModeId'),
            inputModeCoord: document.getElementById('inputModeCoord'),
            
            // INPUTS
            input: document.getElementById('h3Input'),
            latInput: document.getElementById('latInput'),
            lonInput: document.getElementById('lonInput'),
            
            // BUTTONS
            btn: document.getElementById('searchBtn'),
            searchCoordBtn: document.getElementById('searchCoordBtn'),
            locateBtn: document.getElementById('locateBtn'),
            swapBtn: document.getElementById('swapBtn'),
            
            // ERROR & INFO
            errBox: document.getElementById('errorBox'),
            errText: document.getElementById('errorText'),
            errHex: document.getElementById('errorHex'),
            info: document.getElementById('infoPanel'),
            hex: document.getElementById('displayHex'),
            res: document.getElementById('displayRes'),
            area: document.getElementById('displayArea'),
            center: document.getElementById('displayCenter'),
            parentsList: document.getElementById('parentsList'),
            
            // STATS
            statsBtn: document.getElementById('statsBtn'),
            statsModal: document.getElementById('statsModal'),
            closeStatsBtn: document.getElementById('closeStatsBtn'),
            statsTableBody: document.getElementById('statsTableBody')
        };

        // --- TAB LOGIC ---
        let currentMode = 'id'; // 'id' or 'coord'

        function setMode(mode) {
            currentMode = mode;
            if (mode === 'id') {
                els.tabId.classList.add('tab-active');
                els.tabId.classList.remove('tab-inactive');
                els.tabCoord.classList.add('tab-inactive');
                els.tabCoord.classList.remove('tab-active');
                
                els.inputModeId.classList.remove('hidden');
                els.inputModeCoord.classList.add('hidden');
            } else {
                els.tabCoord.classList.add('tab-active');
                els.tabCoord.classList.remove('tab-inactive');
                els.tabId.classList.add('tab-inactive');
                els.tabId.classList.remove('tab-active');
                
                els.inputModeCoord.classList.remove('hidden');
                els.inputModeId.classList.add('hidden');
            }
        }

        els.tabId.addEventListener('click', () => setMode('id'));
        els.tabCoord.addEventListener('click', () => setMode('coord'));

        // --- H3 STATS DATA ---
        const h3Stats = [
            { res: 0, count: "122", edge: "1,107 km", span: "2,215 km", area: "4,250,546 km²" },
            { res: 1, count: "842", edge: "418.6 km", span: "837 km", area: "607,220 km²" },
            { res: 2, count: "5,882", edge: "158.2 km", span: "316 km", area: "86,745 km²" },
            { res: 3, count: "41,162", edge: "59.8 km", span: "120 km", area: "12,392 km²" },
            { res: 4, count: "288,122", edge: "22.6 km", span: "45 km", area: "1,770 km²" },
            { res: 5, count: "2,016,842", edge: "8.5 km", span: "17 km", area: "252.9 km²" },
            { res: 6, count: "14,117,882", edge: "3.2 km", span: "6.4 km", area: "36.1 km²" },
            { res: 7, count: "98,825,162", edge: "1.22 km", span: "2.4 km", area: "5.16 km²" },
            { res: 8, count: "691,776,122", edge: "461 m", span: "922 m", area: "0.73 km²" },
            { res: 9, count: "4,842,432,842", edge: "174 m", span: "348 m", area: "0.10 km²" },
            { res: 10, count: "33.8 Billion", edge: "65.9 m", span: "131 m", area: "15,047 m²" },
            { res: 11, count: "237 Billion", edge: "24.9 m", span: "49 m", area: "2,150 m²" },
            { res: 12, count: "1.66 Trillion", edge: "9.4 m", span: "18 m", area: "307 m²" },
            { res: 13, count: "11.6 Trillion", edge: "3.5 m", span: "7 m", area: "43.8 m²" },
            { res: 14, count: "81 Trillion", edge: "1.3 m", span: "2.6 m", area: "6.3 m²" },
            { res: 15, count: "569 Trillion", edge: "0.5 m", span: "1 m", area: "0.9 m²" },
        ];

        // Fill Stats Table
        h3Stats.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-800/50 transition-colors border-b border-slate-800/50 last:border-0";
            tr.innerHTML = `
                <td class="p-3 font-semibold text-blue-400">Res ${row.res}</td>
                <td class="p-3 text-slate-300">${row.count}</td>
                <td class="p-3 text-slate-400">${row.edge}</td>
                <td class="p-3 text-slate-400">${row.span}</td>
                <td class="p-3 text-emerald-400">${row.area}</td>
            `;
            els.statsTableBody.appendChild(tr);
        });

        // Toggle Modal Logic
        const toggleModal = (show) => {
            if (show) els.statsModal.classList.remove('hidden');
            else els.statsModal.classList.add('hidden');
        };

        els.statsBtn.addEventListener('click', () => toggleModal(true));
        els.closeStatsBtn.addEventListener('click', () => toggleModal(false));
        els.statsModal.addEventListener('click', (e) => {
            if(e.target === els.statsModal) toggleModal(false);
        });

        let currentData = null; 
        let isSwapped = false;  

        // Smart Zoom-to-Res Mapping
        function getResFromZoom(zoom) {
            if (zoom <= 2) return 1;
            if (zoom <= 3) return 2;
            if (zoom <= 4) return 3;
            if (zoom <= 5) return 4;
            if (zoom <= 6) return 5;
            if (zoom <= 8) return 6;
            if (zoom <= 10) return 7;
            if (zoom <= 11) return 8;
            if (zoom <= 12) return 9;
            if (zoom <= 14) return 10;
            if (zoom <= 15) return 11;
            return 12; // High Zoom
        }

        function visualize() {
            if (currentMode === 'id') {
                let val = els.input.value.trim().replace(/['"\s]/g, '');
                if (!val) return;
                visualizeH3(val);
            } else {
                let lat = parseFloat(els.latInput.value);
                let lon = parseFloat(els.lonInput.value);
                
                if (isNaN(lat) || isNaN(lon)) {
                    showError("Invalid Coordinates", "Please enter valid numbers.");
                    return;
                }
                
                // Use Res 10 for detailed coordinate lookup
                try {
                    if (typeof h3 === 'undefined') throw new Error("H3 library not loaded.");
                    const h3Index = h3.latLngToCell(lat, lon, 10);
                    visualizeH3(h3Index);
                } catch(e) {
                    showError("Calculation Error", e.message);
                }
            }
        }

        function visualizeH3(raw) {
            // Reset UI
            els.errBox.classList.add('hidden');
            els.info.classList.add('hidden');
            layerGroup.clearLayers();
            els.parentsList.innerHTML = ''; 
            
            if(!currentData) {
                 isSwapped = false;
                 resetSwapBtn();
            }

            // ROBUST PARSING LOGIC
            let hex = raw.toLowerCase();
            let isValid = false;
            let errorDetail = "";

            try {
                // Check dependencies
                if (typeof h3 === 'undefined') throw new Error("H3 library not loaded.");

                // STRATEGY 1: Attempt as direct HEX first
                if (h3.isValidCell(hex)) {
                    isValid = true;
                } else {
                    // STRATEGY 2: Attempt as Decimal Long
                    if (/^-?\d+$/.test(raw)) {
                        try {
                            const bigIntVal = BigInt(raw);
                            const unsignedVal = BigInt.asUintN(64, bigIntVal);
                            const potentialHex = unsignedVal.toString(16);
                            
                            if (h3.isValidCell(potentialHex)) {
                                hex = potentialHex;
                                isValid = true;
                            } else {
                                errorDetail = `Converted decimal to hex '${potentialHex}', but it was invalid.`;
                            }
                        } catch(innerErr) {
                            errorDetail = "Failed to convert decimal number.";
                        }
                    } else {
                        errorDetail = "Input is not a valid hex string or decimal number.";
                    }
                }

                if (!isValid) throw new Error(`Invalid H3 Index. ${errorDetail}`);

                // H3 Calculations
                const center = h3.cellToLatLng(hex);
                const boundary = h3.cellToBoundary(hex);
                const res = h3.getResolution(hex);
                const area = h3.cellArea(hex, 'km2');

                renderParents(hex, res);
                currentData = { hex, center, boundary, res, area };
                renderMap();
                
                // Fill Inputs based on result to sync Lat/Lon mode
                els.input.value = hex;
                els.latInput.value = center[0].toFixed(6);
                els.lonInput.value = center[1].toFixed(6);

                els.hex.textContent = hex;
                els.res.textContent = `Res ${res}`;
                els.area.textContent = `${area.toFixed(6)} km²`;
                
                els.info.classList.remove('hidden');

            } catch (e) {
                showError(e.message, `Input: ${raw}`);
            }
        }

        function showError(msg, detail) {
            console.error(msg);
            els.errText.textContent = msg;
            els.errHex.textContent = detail || "";
            els.errBox.classList.remove('hidden');
        }

        function renderParents(childHex, childRes) {
            els.parentsList.innerHTML = '';
            if (childRes === 0) {
                els.parentsList.innerHTML = '<div class="text-xs text-slate-500 text-center py-2">No parents (Res 0)</div>';
                return;
            }

            for (let r = childRes - 1; r >= 0; r--) {
                const parentHex = h3.cellToParent(childHex, r);
                const item = document.createElement('div');
                item.className = 'group flex items-center justify-between p-2 rounded cursor-pointer hover:bg-slate-800 border border-transparent hover:border-slate-700 transition-all';
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="bg-purple-900/30 text-purple-300 text-[10px] px-1.5 py-0.5 rounded font-mono border border-purple-500/20">Res ${r}</span>
                        <span class="font-mono text-xs text-slate-300 group-hover:text-white transition-colors">${parentHex}</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-3 h-3 text-slate-600 group-hover:text-blue-400 opacity-0 group-hover:opacity-100 transition-all"></i>
                `;
                item.onclick = () => visualizeH3(parentHex);
                els.parentsList.appendChild(item);
            }
            refreshIcons();
        }

        function renderMap() {
            if (!currentData) return;
            layerGroup.clearLayers();
            let center = [...currentData.center];
            let boundary = currentData.boundary.map(p => [...p]);

            if (isSwapped) {
                center = [center[1], center[0]]; 
                boundary = boundary.map(p => [p[1], p[0]]);
            }

            const poly = L.polygon(boundary, {
                color: isSwapped ? '#fbbf24' : '#4ade80', 
                fillColor: isSwapped ? '#fbbf24' : '#4ade80',
                fillOpacity: 0.2, weight: 2
            }).addTo(layerGroup);

            L.circleMarker(center, {
                radius: 5, color: '#fff', 
                fillColor: isSwapped ? '#f59e0b' : '#3b82f6', 
                fillOpacity: 1
            }).addTo(layerGroup).bindPopup(
                `Center: ${center[0].toFixed(5)}, ${center[1].toFixed(5)}` + 
                (isSwapped ? '<br><b class="text-amber-500">⚠ SWAPPED</b>' : '')
            );

            map.fitBounds(poly.getBounds());
            els.center.innerHTML = `Lat: ${center[0].toFixed(6)} <br> Lon: ${center[1].toFixed(6)}`;
        }

        function resetSwapBtn() {
            els.swapBtn.className = 'mt-3 w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded text-[10px] transition-colors border border-slate-700';
            els.swapBtn.innerHTML = '<i data-lucide="arrow-left-right" class="w-3 h-3"></i> Swap Lat/Lon (Debug)';
            refreshIcons();
        }

        els.swapBtn.addEventListener('click', () => {
            isSwapped = !isSwapped;
            if (isSwapped) {
                els.swapBtn.className = 'mt-3 w-full flex items-center justify-center gap-2 bg-amber-600 hover:bg-amber-500 text-white py-2 rounded text-[10px] transition-colors border border-amber-500 shadow-lg';
                els.swapBtn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> Reset to Original';
            } else {
                resetSwapBtn();
            }
            refreshIcons();
            renderMap();
        });

        // Locate Me with AUTO Resolution
        els.locateBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser.");
                return;
            }
            
            els.locateBtn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Locating...';
            refreshIcons();

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    els.latInput.value = lat;
                    els.lonInput.value = lon;
                    
                    // If in Coord mode, trigger search immediately
                    if(currentMode === 'coord') {
                        visualize();
                    } else {
                        // Switch to ID mode for standard display (auto res based on zoom)
                        const currentZoom = map.getZoom();
                        const targetRes = getResFromZoom(currentZoom);
                        const h3Index = h3.latLngToCell(lat, lon, targetRes);
                        visualizeH3(h3Index);
                    }
                    
                    els.locateBtn.innerHTML = '<i data-lucide="crosshair" class="w-3 h-3"></i> Locate Me';
                    refreshIcons();
                },
                (error) => {
                    console.error(error);
                    alert("Unable to retrieve location. Check permissions.");
                    els.locateBtn.innerHTML = '<i data-lucide="crosshair" class="w-3 h-3"></i> Locate Me';
                    refreshIcons();
                }
            );
        });

        // Map Click Listener with AUTO Resolution
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            els.latInput.value = lat.toFixed(6);
            els.lonInput.value = lng.toFixed(6);

            const currentZoom = map.getZoom();
            const targetRes = getResFromZoom(currentZoom);
            
            try {
                const cell = h3.latLngToCell(lat, lng, targetRes);
                // Always visualize, regardless of mode, but fill inputs
                visualizeH3(cell);
            } catch(err) {
                console.error("Map click error", err);
            }
        });

        els.btn.addEventListener('click', () => visualize());
        els.searchCoordBtn.addEventListener('click', () => visualize());
        els.input.addEventListener('keypress', (e) => { if (e.key === 'Enter') visualize(); });

        window.onload = function() { setTimeout(() => visualize(), 200); };
    </script>
</body>
</html>