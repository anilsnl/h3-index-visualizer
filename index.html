<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H3 Index Visualizer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- H3-js v4.1.0 -->
    <script src="https://unpkg.com/h3-js@4.1.0/dist/h3-js.umd.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .leaflet-layer { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        .leaflet-container { background: #1e293b; cursor: crosshair; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .tab-btn { transition: all 0.2s ease-in-out; }
        .tab-active { background-color: #2563eb; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .tab-inactive { background-color: transparent; color: #94a3b8; }
        .tab-inactive:hover { color: white; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 font-sans h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="bg-slate-800 p-4 shadow-lg border-b border-slate-700 flex justify-between items-center z-20">
        <div class="flex items-center gap-2">
            <i data-lucide="layers" class="text-blue-400"></i>
            <h1 class="text-xl font-bold text-white">H3 Index Visualizer</h1>
        </div>
        
        <div class="flex items-center gap-4">
            <!-- GitHub Link -->
            <a href="https://github.com/anilsnl/h3-index-visualizer" target="_blank" class="hidden sm:flex text-xs text-slate-400 hover:text-white transition-colors items-center gap-1.5 bg-slate-700/50 hover:bg-slate-700 px-3 py-1.5 rounded-full border border-slate-600/50">
                <i data-lucide="github" class="w-3.5 h-3.5"></i>
                <span data-i18n="githubLabel">GitHub Repo</span>
            </a>

            <!-- Language Switcher -->
            <div class="flex bg-slate-700 rounded p-0.5 border border-slate-600">
                <button onclick="setLanguage('tr')" class="lang-btn px-2 py-0.5 text-[10px] rounded hover:bg-slate-600 transition-colors text-slate-400" id="btn-tr">TR</button>
                <button onclick="setLanguage('en')" class="lang-btn px-2 py-0.5 text-[10px] rounded hover:bg-slate-600 transition-colors font-bold text-white bg-slate-500" id="btn-en">EN</button>
                <button onclick="setLanguage('de')" class="lang-btn px-2 py-0.5 text-[10px] rounded hover:bg-slate-600 transition-colors text-slate-400" id="btn-de">DE</button>
            </div>
        </div>
    </header>

    <div class="flex flex-col md:flex-row flex-1 overflow-hidden relative">
        
        <!-- SIDEBAR -->
        <div class="w-full md:w-96 bg-slate-800/90 backdrop-blur-sm p-6 flex flex-col gap-6 border-r border-slate-700 z-10 overflow-y-auto h-1/3 md:h-full shadow-xl custom-scroll flex-shrink-0">
            
            <!-- SEARCH CONTROLS -->
            <div class="space-y-4">
                
                <!-- MODE TABS -->
                <div class="flex bg-slate-900 p-1 rounded-lg border border-slate-700">
                    <button id="tabId" class="tab-btn tab-active flex-1 py-1.5 text-xs font-medium rounded-md flex justify-center items-center gap-2">
                        <i data-lucide="hash" class="w-3 h-3"></i> <span data-i18n="tabId">H3 ID ile</span>
                    </button>
                    <button id="tabCoord" class="tab-btn tab-inactive flex-1 py-1.5 text-xs font-medium rounded-md flex justify-center items-center gap-2">
                        <i data-lucide="map-pin" class="w-3 h-3"></i> <span data-i18n="tabCoord">Koordinat ile</span>
                    </button>
                </div>

                <!-- ID INPUT MODE -->
                <div id="inputModeId" class="space-y-3">
                    <div class="flex justify-between items-end">
                        <label class="text-sm font-medium text-slate-300" data-i18n="labelIdInput">H3 ID Girişi</label>
                        <span class="text-[10px] text-slate-500 bg-slate-800 px-2 py-1 rounded border border-slate-700" data-i18n="spanAutoRes">
                            Çözünürlük otomatik algılanır
                        </span>
                    </div>

                    <!-- FORMAT SELECTION RADIO -->
                    <div class="bg-slate-800/50 p-2 rounded border border-slate-700/50 flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="radio" name="idFormat" value="hex" checked class="accent-blue-500 w-4 h-4 cursor-pointer">
                            <span class="text-xs text-slate-300 group-hover:text-white" data-i18n="radioHex">Hexadecimal</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="radio" name="idFormat" value="decimal" class="accent-blue-500 w-4 h-4 cursor-pointer">
                            <span class="text-xs text-slate-300 group-hover:text-white" data-i18n="radioDec">Decimal (Long)</span>
                        </label>
                    </div>

                    <!-- K-FACTOR SELECTION -->
                    <div class="bg-slate-800/50 p-2 rounded border border-slate-700/50">
                        <label class="text-xs text-slate-400 uppercase font-bold mb-2 block" data-i18n="labelKFactor">
                            K-Factor (Neighborhood Rings)
                        </label>
                        <select id="kFactorSelect"
                                class="w-full bg-slate-900 border border-slate-600 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-blue-500 text-sm cursor-pointer">
                            <option value="unset" data-i18n="kFactorUnset">None (Main cell only)</option>
                            <option value="1">k=1 (1 ring)</option>
                            <option value="2">k=2 (2 rings)</option>
                            <option value="3">k=3 (3 rings)</option>
                            <option value="4">k=4 (4 rings)</option>
                            <option value="5">k=5 (5 rings)</option>
                            <option value="6">k=6 (6 rings)</option>
                            <option value="7">k=7 (7 rings)</option>
                            <option value="8">k=8 (8 rings)</option>
                            <option value="9">k=9 (9 rings)</option>
                            <option value="10">k=10 (10 rings)</option>
                        </select>
                        <div class="text-[10px] text-slate-500 mt-1 flex items-center gap-1">
                            <i data-lucide="info" class="w-3 h-3"></i>
                            <span data-i18n="kFactorHint">Shows neighboring cells within k rings</span>
                        </div>
                    </div>

                    <div class="relative">
                        <input type="text" id="h3Input" placeholder="Örn: 8928308280fffff" value=""
                            class="w-full bg-slate-900 border border-slate-600 rounded-lg py-3 pl-4 pr-12 text-white focus:ring-2 focus:ring-blue-500 font-mono text-sm shadow-inner transition-all">
                        
                        <button id="searchBtn" class="absolute right-2 top-2 p-1.5 bg-blue-600 hover:bg-blue-500 rounded-md transition-colors shadow-lg">
                            <i data-lucide="search" class="text-white w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <!-- 64-bit Warning Indicator (Hidden by default) -->
                    <div id="bigIntWarning" class="hidden text-[10px] text-amber-400 flex items-center gap-1 bg-amber-900/20 p-1.5 rounded border border-amber-900/50">
                        <i data-lucide="cpu" class="w-3 h-3"></i> 64-bit Precision Mode Active
                    </div>
                </div>

                <!-- LAT/LON INPUT MODE -->
                <div id="inputModeCoord" class="space-y-3 hidden">
                    <div class="flex justify-between items-end">
                        <label class="text-sm font-medium text-slate-300" data-i18n="labelCoords">Koordinatlar</label>
                        <span class="text-[10px] text-slate-500 bg-slate-800 px-2 py-1 rounded border border-slate-700" data-i18n="spanRes12">
                            Res 15 (Maksimum Detay) Hesaplanır
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="text-[10px] text-slate-400 uppercase font-bold pl-1" data-i18n="labelLat">Enlem (Lat)</label>
                            <input type="text" id="latInput" placeholder="39.925"
                                class="w-full bg-slate-900 border border-slate-600 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-blue-500 font-mono text-sm">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-slate-400 uppercase font-bold pl-1" data-i18n="labelLon">Boylam (Lon)</label>
                            <input type="text" id="lonInput" placeholder="32.836944"
                                class="w-full bg-slate-900 border border-slate-600 rounded-lg py-2 px-3 text-white focus:ring-2 focus:ring-blue-500 font-mono text-sm">
                        </div>
                    </div>

                    <button id="searchCoordBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-medium py-2 rounded-lg transition-colors shadow-lg flex justify-center items-center gap-2 text-sm">
                        <i data-lucide="search" class="w-4 h-4"></i> <span data-i18n="btnFind">H3 Hücresini Bul</span>
                    </button>
                </div>

                <!-- Action Row -->
                <div class="flex justify-between items-center pt-2">
                    <span class="text-[10px] text-slate-500 italic flex items-center gap-1" data-i18n="hintMap">
                        <i data-lucide="mouse-pointer-2" class="w-3 h-3"></i> Hücre seçmek için haritaya tıkla
                    </span>
                    <button id="locateBtn" class="text-xs flex items-center gap-1 bg-slate-800 hover:bg-slate-700 text-blue-400 px-3 py-1.5 rounded border border-slate-700 transition-colors shadow-sm" title="Seçili çözünürlükte konumu bul">
                        <i data-lucide="crosshair" class="w-3 h-3"></i> <span data-i18n="btnLocate">Konumumu Bul</span>
                    </button>
                </div>
            </div>

            <!-- Error Box -->
            <div id="errorBox" class="hidden bg-red-500/10 border border-red-500/50 rounded-lg p-3 flex flex-col gap-2 animate-pulse">
                <div class="flex items-center gap-2 text-red-400 font-bold text-sm">
                    <i data-lucide="alert-circle" class="w-5 h-5"></i> Error
                </div>
                <p id="errorText" class="text-sm text-red-200"></p>
                <div class="w-full mt-2 pt-2 border-t border-red-500/30 text-xs text-white bg-red-900/50 p-1 rounded font-mono break-all" id="errorHex"></div>
            </div>

            <!-- Info Panel -->
            <div id="infoPanel" class="hidden flex flex-col gap-4">
                
                <!-- Main Details Card -->
                <div class="bg-slate-900 rounded-xl border border-slate-700 overflow-hidden shadow-lg">
                    <div class="bg-slate-800 px-4 py-2 border-b border-slate-700 font-semibold text-sm flex justify-between items-center text-slate-200">
                        <span class="flex items-center gap-2"><i data-lucide="info" class="text-blue-400 w-4 h-4"></i> <span data-i18n="headerDetails">Hücre Detayları</span></span>
                    </div>
                    
                    <div class="p-4 space-y-4">
                        <!-- TYPE INDICATOR -->
                        <div id="typeIndicator" class="hidden">
                            <div class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 font-bold" data-i18n="labelType">Tip</div>
                            <span id="typeBadge" class="bg-amber-600/20 text-amber-300 px-2 py-0.5 rounded text-xs border border-amber-600/30 font-mono inline-block">Directed Edge</span>
                        </div>

                        <div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 font-bold">Hex ID</div>
                            <div id="displayHex" class="font-mono text-green-400 text-lg break-all leading-tight"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 font-bold" data-i18n="labelRes">Resolution (Çözünürlük)</div>
                                <span id="displayRes" class="bg-blue-600/20 text-blue-300 px-2 py-0.5 rounded text-xs border border-blue-600/30 font-mono"></span>
                            </div>
                            <div>
                                <div class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 font-bold" data-i18n="labelArea">Alan (Yaklaşık)</div>
                                <div id="displayArea" class="text-slate-300 text-sm font-mono"></div>
                            </div>
                        </div>

                        <div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-wider mb-1 font-bold" data-i18n="labelCenter">Merkez Koordinatları</div>
                            <div id="displayCenter" class="font-mono text-xs text-slate-400 bg-slate-800/50 p-2 rounded border border-slate-700/50"></div>
                            
                            <button id="swapBtn" class="mt-3 w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded text-[10px] transition-colors border border-slate-700">
                                <i data-lucide="arrow-left-right" class="w-3 h-3"></i>
                                <span data-i18n="btnSwap">Lat/Lon Ters Çevir (Debug)</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Parents List -->
                <div class="bg-slate-900 rounded-xl border border-slate-700 overflow-hidden shadow-lg">
                    <div class="bg-slate-800 px-4 py-2 border-b border-slate-700 font-semibold text-sm flex justify-between items-center text-slate-200">
                        <span class="flex items-center gap-2"><i data-lucide="arrow-up-circle" class="text-purple-400 w-4 h-4"></i> <span data-i18n="headerParents">Üst Katmanlar (Uzaklaş)</span></span>
                    </div>
                    <div class="max-h-48 overflow-y-auto custom-scroll p-2 space-y-1" id="parentsList">
                        <!-- Parent items will be injected here -->
                    </div>
                </div>
            </div>

            <!-- Footer Area -->
            <div class="mt-auto pt-4 border-t border-slate-700 space-y-3">
                <button id="statsBtn" class="w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded text-xs transition-colors border border-slate-700 shadow-sm hover:shadow-md hover:border-slate-600">
                    <i data-lucide="table" class="w-3 h-3"></i> <span data-i18n="btnTable">H3 Referans Tablosu</span>
                </button>
                
                <div class="text-center">
                    <a href="https://h3geo.org/docs/" target="_blank" class="text-[10px] text-blue-400 hover:text-blue-300 transition-colors flex items-center justify-center gap-1">
                        <i data-lucide="external-link" class="w-3 h-3"></i> <span data-i18n="linkDocs">H3 Resmi Dokümantasyon</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- MAP -->
        <div id="map" class="flex-1 h-2/3 md:h-full bg-slate-900 z-0"></div>
    </div>

    <!-- STATS MODAL -->
    <div id="statsModal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-4xl max-h-[90vh] rounded-xl border border-slate-700 shadow-2xl flex flex-col animate-in fade-in zoom-in duration-200">
            <!-- Modal Header -->
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800 rounded-t-xl">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <i data-lucide="table" class="text-blue-400"></i> <span data-i18n="modalTitle">H3 Çözünürlük İstatistikleri</span>
                </h2>
                <button id="closeStatsBtn" class="text-slate-400 hover:text-white hover:bg-slate-700 p-1 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Modal Body (Table) -->
            <div class="overflow-auto p-0 custom-scroll">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-800/50 sticky top-0 z-10">
                        <tr class="text-xs text-slate-400 uppercase border-b border-slate-700">
                            <th class="p-3 font-semibold whitespace-nowrap" data-i18n="thRes">Res</th>
                            <th class="p-3 font-semibold" data-i18n="thCount">Toplam Altıgen</th>
                            <th class="p-3 font-semibold" data-i18n="thEdge">Kenar Uzunluğu</th>
                            <th class="p-3 font-semibold" data-i18n="thSpan">Ortalama Çap</th>
                            <th class="p-3 font-semibold" data-i18n="thArea">Ortalama Alan</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody" class="text-sm text-slate-300 font-mono divide-y divide-slate-800">
                        <!-- JS generated rows -->
                    </tbody>
                </table>
            </div>
            
            <!-- Modal Footer -->
            <div class="p-3 border-t border-slate-700 bg-slate-800/50 text-[10px] text-slate-500 text-center rounded-b-xl" data-i18n="modalFooter">
                Değerler H3 dokümantasyonundan alınan yaklaşık ortalamalardır.
            </div>
        </div>
    </div>

    <script>
        // LANGUAGE DICTIONARY
        const i18n = {
            tr: {
                githubLabel: "GitHub Repo",
                tabId: "H3 ID ile", tabCoord: "Koordinat ile",
                labelIdInput: "H3 ID Girişi", spanAutoRes: "Çözünürlük otomatik algılanır",
                radioHex: "Hexadecimal", radioDec: "Decimal (Long)",
                labelCoords: "Koordinatlar", spanRes12: "Res 15 (Maksimum Detay) Hesaplanır",
                labelLat: "Enlem (Lat)", labelLon: "Boylam (Lon)",
                btnFind: "H3 Hücresini Bul", hintMap: "Hücre seçmek için haritaya tıkla", btnLocate: "Konumumu Bul",
                headerDetails: "Hücre Detayları", labelType: "Tip", labelRes: "Çözünürlük (Res)", labelArea: "Alan (Yaklaşık)",
                labelCenter: "Merkez Koordinatları", btnSwap: "Lat/Lon Ters Çevir (Debug)",
                headerParents: "Üst Katmanlar (Uzaklaş)", btnTable: "H3 Referans Tablosu", linkDocs: "H3 Resmi Dokümantasyon",
                modalTitle: "H3 Çözünürlük İstatistikleri", modalFooter: "Değerler H3 dokümantasyonundan alınan yaklaşık ortalamalardır.",
                thRes: "Res", thCount: "Toplam Altıgen", thEdge: "Kenar Uzunluğu", thSpan: "Ortalama Çap", thArea: "Ortalama Alan",
                errDecimal: "Decimal modunda sadece rakam (Negatif dahil) giriniz.",
                errConvert: "Sayı dönüştürülemedi: ",
                errInvalid: "Geçersiz H3 İndeksi.",
                typeEdge: "Yönlendirilmiş Kenar (Başlangıç)",
                typeVertex: "Vertex (Nokta)",
                phHex: "Örn: 8928308280fffff", phDec: "Örn: 617700169546072063",
                errCoordEmpty: "Hatalı Koordinat: Lütfen Enlem ve Boylam giriniz.",
                errCoordNan: "Hatalı Koordinat: Lütfen geçerli sayı giriniz.",
                labelKFactor: "K-Faktör (Komşuluk Halkaları)",
                kFactorUnset: "Yok (Sadece ana hücre)",
                kFactorHint: "K halka içindeki komşu hücreleri gösterir"
            },
            en: {
                githubLabel: "GitHub Repo",
                tabId: "By H3 ID", tabCoord: "By Lat/Lon",
                labelIdInput: "H3 ID Input", spanAutoRes: "Auto-detects Resolution",
                radioHex: "Hexadecimal", radioDec: "Decimal (Long)",
                labelCoords: "Coordinates", spanRes12: "Calculates Res 15 (Maximum Detail)",
                labelLat: "Latitude", labelLon: "Longitude",
                btnFind: "Find H3 Cell", hintMap: "Click map to pick cell", btnLocate: "Locate Me",
                headerDetails: "Cell Details", labelType: "Type", labelRes: "Resolution", labelArea: "Area (Approx)",
                labelCenter: "Center Coordinates", btnSwap: "Swap Lat/Lon (Debug)",
                headerParents: "Parent Layers (Zoom Out)", btnTable: "H3 Reference Table", linkDocs: "H3 Official Docs",
                modalTitle: "H3 Resolution Statistics", modalFooter: "Values are approximate averages based on H3 docs.",
                thRes: "Res", thCount: "Total Hexagons", thEdge: "Edge Length", thSpan: "Avg Diameter", thArea: "Avg Area",
                errDecimal: "Only numbers allowed in Decimal mode.",
                errConvert: "Conversion failed: ",
                errInvalid: "Invalid H3 Index.",
                typeEdge: "Directed Edge (Origin)",
                typeVertex: "Vertex (Point)",
                phHex: "Ex: 8928308280fffff", phDec: "Ex: 617700169546072063",
                errCoordEmpty: "Invalid Coords: Please enter Lat and Lon.",
                errCoordNan: "Invalid Coords: Please enter valid numbers.",
                labelKFactor: "K-Factor (Neighborhood Rings)",
                kFactorUnset: "None (Main cell only)",
                kFactorHint: "Shows neighboring cells within k rings"
            },
            de: {
                githubLabel: "GitHub Repo",
                tabId: "Nach H3-ID", tabCoord: "Nach Koordinaten",
                labelIdInput: "H3-ID Eingabe", spanAutoRes: "Auflösung autom. erkannt",
                radioHex: "Hexadezimal", radioDec: "Dezimal (Long)",
                labelCoords: "Koordinaten", spanRes12: "Berechnet Res 15 (Maximale Details)",
                labelLat: "Breitengrad", labelLon: "Längengrad",
                btnFind: "H3-Zelle finden", hintMap: "Klicken Sie auf die Karte", btnLocate: "Mein Standort",
                headerDetails: "Zellendetails", labelType: "Typ", labelRes: "Auflösung", labelArea: "Fläche (ca.)",
                labelCenter: "Mittelpunktkoordinaten", btnSwap: "Lat/Lon tauschen (Debug)",
                headerParents: "Übergeordnete Ebenen", btnTable: "H3-Referenztabelle", linkDocs: "H3 Dokumentation",
                modalTitle: "H3-Auflösungsstatistiken", modalFooter: "Werte sind Näherungswerte basierend auf der H3-Dokumentation.",
                thRes: "Res", thCount: "Gesamt Hexagone", thEdge: "Kantenlänge", thSpan: "Ø Durchmesser", thArea: "Ø Fläche",
                errDecimal: "Im Dezimalmodus nur Zahlen erlaubt.",
                errConvert: "Konvertierung fehlgeschlagen: ",
                errInvalid: "Ungültiger H3-Index.",
                typeEdge: "Gerichtete Kante (Ursprung)",
                typeVertex: "Vertex (Punkt)",
                phHex: "Bsp: 8928308280fffff", phDec: "Bsp: 617700169546072063",
                errCoordEmpty: "Ungültige Koordinaten: Bitte Lat und Lon eingeben.",
                errCoordNan: "Ungültige Koordinaten: Bitte gültige Zahlen eingeben.",
                labelKFactor: "K-Faktor (Nachbarschaftsringe)",
                kFactorUnset: "Keine (nur Hauptzelle)",
                kFactorHint: "Zeigt Nachbarzellen innerhalb von k Ringen"
            }
        };

        // Detect browser language and set default
        function detectLanguage() {
            const browserLang = navigator.language || navigator.userLanguage;
            const langCode = browserLang.split('-')[0].toLowerCase();

            // Check if detected language is supported (tr, en, de)
            if (langCode === 'tr' || langCode === 'en' || langCode === 'de') {
                return langCode;
            }

            // Default to English if not supported
            return 'en';
        }

        let currentLang = detectLanguage();

        function setLanguage(lang) {
            currentLang = lang;
            
            // Update UI Text
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(i18n[lang][key]) el.textContent = i18n[lang][key];
            });

            // Update Placeholders
            if(currentIdFormat === 'hex') document.getElementById('h3Input').placeholder = i18n[lang].phHex;
            else document.getElementById('h3Input').placeholder = i18n[lang].phDec;

            // Highlight Buttons
            ['tr', 'en', 'de'].forEach(l => {
                const btn = document.getElementById(`btn-${l}`);
                if(l === lang) {
                    btn.classList.remove('text-slate-400', 'bg-transparent');
                    btn.classList.add('text-white', 'bg-slate-500', 'font-bold');
                } else {
                    btn.classList.add('text-slate-400', 'bg-transparent');
                    btn.classList.remove('text-white', 'bg-slate-500', 'font-bold');
                }
            });
        }

        // Safe Icon Refresher
        const refreshIcons = () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        // Initial icon load
        refreshIcons();

        // Initialize Map centered on Anitkabir (Ankara, Turkey)
        // Zoom level 14 is a good starting point for Res 8/9 visualization
        const map = L.map('map').setView([39.925, 32.836944], 14);
        
        // CartoDB Dark Matter Tiles for dark mode compatibility
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap, © CARTO', 
            subdomains: 'abcd', 
            maxZoom: 20 // Supports deep zooming for Res 15
        }).addTo(map);

        const layerGroup = L.layerGroup().addTo(map);
        
        // Element References
        const els = {
            // TABS
            tabId: document.getElementById('tabId'),
            tabCoord: document.getElementById('tabCoord'),
            inputModeId: document.getElementById('inputModeId'),
            inputModeCoord: document.getElementById('inputModeCoord'),
            
            // INPUTS
            input: document.getElementById('h3Input'),
            latInput: document.getElementById('latInput'),
            lonInput: document.getElementById('lonInput'),
            idFormats: document.getElementsByName('idFormat'),
            kFactorSelect: document.getElementById('kFactorSelect'),
            
            // BUTTONS
            btn: document.getElementById('searchBtn'),
            searchCoordBtn: document.getElementById('searchCoordBtn'),
            locateBtn: document.getElementById('locateBtn'),
            swapBtn: document.getElementById('swapBtn'),
            
            // ERROR & INFO
            errBox: document.getElementById('errorBox'),
            errText: document.getElementById('errorText'),
            errHex: document.getElementById('errorHex'),
            info: document.getElementById('infoPanel'),
            typeIndicator: document.getElementById('typeIndicator'),
            typeBadge: document.getElementById('typeBadge'),
            bigIntWarning: document.getElementById('bigIntWarning'),
            hex: document.getElementById('displayHex'),
            res: document.getElementById('displayRes'),
            area: document.getElementById('displayArea'),
            center: document.getElementById('displayCenter'),
            parentsList: document.getElementById('parentsList'),
            
            // STATS
            statsBtn: document.getElementById('statsBtn'),
            statsModal: document.getElementById('statsModal'),
            closeStatsBtn: document.getElementById('closeStatsBtn'),
            statsTableBody: document.getElementById('statsTableBody')
        };

        // --- FORMAT SELECTION LOGIC ---
        let currentIdFormat = 'hex'; // Default
        let currentKFactor = 'unset'; // Default: no neighbors shown
        
        // Listener for Radio Buttons
        els.idFormats.forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentIdFormat = e.target.value;
                // Update placeholder based on selection & lang
                if(currentIdFormat === 'hex') {
                    els.input.placeholder = i18n[currentLang].phHex;
                } else {
                    els.input.placeholder = i18n[currentLang].phDec;
                }
            });
        });

        // --- K-FACTOR SELECTION LOGIC ---
        els.kFactorSelect.addEventListener('change', (e) => {
            currentKFactor = e.target.value;

            // Re-render if there's current data
            if (currentData) {
                renderMap();
            }
        });

        // --- TAB LOGIC ---
        let currentMode = 'id'; // 'id' or 'coord'

        function setMode(mode) {
            currentMode = mode;
            if (mode === 'id') {
                els.tabId.classList.add('tab-active');
                els.tabId.classList.remove('tab-inactive');
                els.tabCoord.classList.add('tab-inactive');
                els.tabCoord.classList.remove('tab-active');
                
                els.inputModeId.classList.remove('hidden');
                els.inputModeCoord.classList.add('hidden');
            } else {
                els.tabCoord.classList.add('tab-active');
                els.tabCoord.classList.remove('tab-inactive');
                els.tabId.classList.add('tab-inactive');
                els.tabId.classList.remove('tab-active');
                
                els.inputModeCoord.classList.remove('hidden');
                els.inputModeId.classList.add('hidden');
            }
        }

        els.tabId.addEventListener('click', () => setMode('id'));
        els.tabCoord.addEventListener('click', () => setMode('coord'));

        // --- H3 STATS DATA ---
        const h3Stats = [
            { res: 0, count: "122", edge: "1,107 km", span: "2,215 km", area: "4,250,546 km²" },
            { res: 1, count: "842", edge: "418.6 km", span: "837 km", area: "607,220 km²" },
            { res: 2, count: "5,882", edge: "158.2 km", span: "316 km", area: "86,745 km²" },
            { res: 3, count: "41,162", edge: "59.8 km", span: "120 km", area: "12,392 km²" },
            { res: 4, count: "288,122", edge: "22.6 km", span: "45 km", area: "1,770 km²" },
            { res: 5, count: "2,016,842", edge: "8.5 km", span: "17 km", area: "252.9 km²" },
            { res: 6, count: "14,117,882", edge: "3.2 km", span: "6.4 km", area: "36.1 km²" },
            { res: 7, count: "98,825,162", edge: "1.22 km", span: "2.4 km", area: "5.16 km²" },
            { res: 8, count: "691,776,122", edge: "461 m", span: "922 m", area: "0.73 km²" },
            { res: 9, count: "4,842,432,842", edge: "174 m", span: "348 m", area: "0.10 km²" },
            { res: 10, count: "33.8 Billion", edge: "65.9 m", span: "131 m", area: "15,047 m²" },
            { res: 11, count: "237 Billion", edge: "24.9 m", span: "49 m", area: "2,150 m²" },
            { res: 12, count: "1.66 Trillion", edge: "9.4 m", span: "18 m", area: "307 m²" },
            { res: 13, count: "11.6 Trillion", edge: "3.5 m", span: "7 m", area: "43.8 m²" },
            { res: 14, count: "81 Trillion", edge: "1.3 m", span: "2.6 m", area: "6.3 m²" },
            { res: 15, count: "569 Trillion", edge: "0.5 m", span: "1 m", area: "0.9 m²" },
        ];

        // Fill Stats Table
        h3Stats.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-800/50 transition-colors border-b border-slate-800/50 last:border-0";
            tr.innerHTML = `
                <td class="p-3 font-semibold text-blue-400">Res ${row.res}</td>
                <td class="p-3 text-slate-300">${row.count}</td>
                <td class="p-3 text-slate-400">${row.edge}</td>
                <td class="p-3 text-slate-400">${row.span}</td>
                <td class="p-3 text-emerald-400">${row.area}</td>
            `;
            els.statsTableBody.appendChild(tr);
        });

        // Toggle Modal Logic
        const toggleModal = (show) => {
            if (show) els.statsModal.classList.remove('hidden');
            else els.statsModal.classList.add('hidden');
        };

        els.statsBtn.addEventListener('click', () => toggleModal(true));
        els.closeStatsBtn.addEventListener('click', () => toggleModal(false));
        // Close on clicking outside
        els.statsModal.addEventListener('click', (e) => {
            if(e.target === els.statsModal) toggleModal(false);
        });

        let currentData = null; 
        let isSwapped = false;  

        // Smart Zoom-to-Res Mapping
        // Updated to include Res 15 for high zoom levels
        function getResFromZoom(zoom) {
            if (zoom <= 2) return 1;
            if (zoom <= 3) return 2;
            if (zoom <= 4) return 3;
            if (zoom <= 5) return 4;
            if (zoom <= 6) return 5;
            if (zoom <= 8) return 6;
            if (zoom <= 10) return 7;
            if (zoom <= 11) return 8;
            if (zoom <= 12) return 9;
            if (zoom <= 13) return 10;
            if (zoom <= 14) return 11;
            if (zoom <= 15) return 12;
            if (zoom <= 16) return 13;
            if (zoom <= 18) return 14;
            return 15; // Max detail (Res 15) for zooms > 18
        }

        function visualize() {
            if (currentMode === 'id') {
                let val = els.input.value.trim().replace(/['"\s]/g, '');
                if (!val) return;
                visualizeH3(val);
            } else {
                let latVal = els.latInput.value.trim();
                let lonVal = els.lonInput.value.trim();

                if (!latVal || !lonVal) {
                    showError(i18n[currentLang].errCoordEmpty);
                    return;
                }

                let lat = parseFloat(latVal);
                let lon = parseFloat(lonVal);
                
                if (isNaN(lat) || isNaN(lon)) {
                    showError(i18n[currentLang].errCoordNan);
                    return;
                }

                // Use Res 15 for maximum detail coordinate lookup
                try {
                    if (typeof h3 === 'undefined') throw new Error("H3 library not loaded.");
                    const h3Index = h3.latLngToCell(lat, lon, 15);
                    
                    // For coordinate lookup, we use Hex format for display
                    currentIdFormat = 'hex';
                    document.querySelector('input[name="idFormat"][value="hex"]').checked = true;
                    
                    visualizeH3(h3Index);
                } catch(e) {
                    showError("Hesaplama Hatası", e.message);
                }
            }
        }

        function visualizeH3(raw) {
            // Reset UI
            els.errBox.classList.add('hidden');
            els.info.classList.add('hidden');
            els.typeIndicator.classList.add('hidden'); 
            els.bigIntWarning.classList.add('hidden');
            layerGroup.clearLayers();
            els.parentsList.innerHTML = ''; 
            
            if(!currentData) {
                 isSwapped = false;
                 resetSwapBtn();
            }

            // --- STRICT FORMAT HANDLING ---
            let hex = raw.toLowerCase();
            let isValid = false;
            let isEdge = false;
            let isVertex = false;
            let errorDetail = "";

            try {
                // Check dependencies
                if (typeof h3 === 'undefined') throw new Error("H3 library not loaded.");

                // 1. DECIMAL MODE: Force Conversion
                if (currentIdFormat === 'decimal') {
                    if (!/^-?\d+$/.test(raw)) {
                        throw new Error(i18n[currentLang].errDecimal);
                    }
                    try {
                        const bigIntVal = BigInt(raw);
                        
                        // Check if 64-bit precision is really needed (safeguard warning)
                        // JS Number.MAX_SAFE_INTEGER is 2^53-1. If larger, BigInt is essential.
                        if (bigIntVal > Number.MAX_SAFE_INTEGER || bigIntVal < Number.MIN_SAFE_INTEGER) {
                            els.bigIntWarning.classList.remove('hidden');
                        }

                        // Convert to unsigned 64-bit integer equivalent
                        const unsignedVal = BigInt.asUintN(64, bigIntVal);
                        hex = unsignedVal.toString(16);
                    } catch(e) {
                        throw new Error(i18n[currentLang].errConvert + e.message);
                    }
                } 
                // 2. HEX MODE: Use as is
                else {
                    // Just basic cleanup if needed, already lowercase
                }

                // VALIDATION CHAIN
                if (h3.isValidCell(hex)) {
                    isValid = true;
                } 
                else if (h3.isValidDirectedEdge(hex)) {
                    isValid = true;
                    isEdge = true;
                }
                else if (h3.isValidVertex && h3.isValidVertex(hex)) {
                    isValid = true;
                    isVertex = true;
                }

                if (!isValid) throw new Error(i18n[currentLang].errInvalid);

                els.errHex.textContent = `Hex: ${hex}`;

                // H3 Calculations
                let center, boundary, res, area, visualHex;

                if (isEdge) {
                    // Handle Edge: Visualize Origin Cell
                    const cells = h3.directedEdgeToCells(hex);
                    visualHex = cells[0];
                    els.typeBadge.textContent = i18n[currentLang].typeEdge;
                    els.typeIndicator.classList.remove('hidden');
                } 
                else if (isVertex) {
                     center = h3.vertexToLatLng(hex);
                     visualHex = null; // No polygon
                     els.typeBadge.textContent = i18n[currentLang].typeVertex;
                     els.typeIndicator.classList.remove('hidden');
                     res = h3.getResolution(hex);
                     area = 0;
                }
                else {
                    visualHex = hex;
                }

                if (visualHex) {
                    center = h3.cellToLatLng(visualHex);
                    boundary = h3.cellToBoundary(visualHex);
                    res = h3.getResolution(visualHex);
                    area = h3.cellArea(visualHex, 'km2');
                    renderParents(visualHex, res);
                }

                currentData = { hex: visualHex || hex, center, boundary, res, area, isVertex };
                renderMap();
                
                // Fill Inputs - Sync both H3 ID and Lat/Lon inputs
                els.input.value = hex; // Always show the actual hex value
                if(center) {
                    els.latInput.value = center[0].toFixed(6);
                    els.lonInput.value = center[1].toFixed(6);
                }

                els.hex.textContent = hex;
                els.res.textContent = `Res ${res}`;
                els.area.textContent = area ? `${area.toFixed(6)} km²` : "N/A";
                
                els.info.classList.remove('hidden');

            } catch (e) {
                showError(e.message, `Input: ${raw}`);
            }
        }

        function showError(msg, detail) {
            console.error(msg); // Log for debugging, but UI handles user feedback
            els.errText.textContent = msg;
            els.errHex.textContent = detail || "";
            els.errBox.classList.remove('hidden');
        }

        function renderParents(childHex, childRes) {
            els.parentsList.innerHTML = '';
            if (!childHex || childRes === 0) {
                els.parentsList.innerHTML = `<div class="text-xs text-slate-500 text-center py-2">Res 0</div>`;
                return;
            }

            for (let r = childRes - 1; r >= 0; r--) {
                const parentHex = h3.cellToParent(childHex, r);
                const item = document.createElement('div');
                item.className = 'group flex items-center justify-between p-2 rounded cursor-pointer hover:bg-slate-800 border border-transparent hover:border-slate-700 transition-all';
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="bg-purple-900/30 text-purple-300 text-[10px] px-1.5 py-0.5 rounded font-mono border border-purple-500/20">Res ${r}</span>
                        <span class="font-mono text-xs text-slate-300 group-hover:text-white transition-colors">${parentHex}</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-3 h-3 text-slate-600 group-hover:text-blue-400 opacity-0 group-hover:opacity-100 transition-all"></i>
                `;
                item.onclick = () => {
                    // Switch to HEX mode for parent visualization to avoid confusion
                    currentIdFormat = 'hex';
                    document.querySelector('input[name="idFormat"][value="hex"]').checked = true;
                    visualizeH3(parentHex);
                };
                els.parentsList.appendChild(item);
            }
            refreshIcons();
        }

        function renderMap() {
            if (!currentData) return;
            layerGroup.clearLayers();
            
            if (!currentData.center) return;

            let center = [...currentData.center];
            let boundary = currentData.boundary ? currentData.boundary.map(p => [...p]) : null;

            if (isSwapped) {
                center = [center[1], center[0]];
                if(boundary) boundary = boundary.map(p => [p[1], p[0]]);
            }

            // --- RENDER NEIGHBORS FIRST (so main cell renders on top) ---
            if (currentKFactor !== 'unset' && currentData.hex && !currentData.isVertex) {
                renderNeighbors(currentData.hex, parseInt(currentKFactor));
            }

            if (boundary) {
                const poly = L.polygon(boundary, {
                    color: isSwapped ? '#fbbf24' : '#4ade80',
                    fillColor: isSwapped ? '#fbbf24' : '#4ade80',
                    fillOpacity: 0.3, // Increased from 0.2 to stand out from neighbors
                    weight: 3 // Increased from 2 for thicker border
                }).addTo(layerGroup);

                // Only auto-fit bounds when neighbors are not shown
                if (currentKFactor === 'unset') {
                    map.fitBounds(poly.getBounds());
                }
            } else {
                map.setView(center, 13);
            }

            L.circleMarker(center, {
                radius: 6, // Slightly larger
                color: '#fff',
                fillColor: isSwapped ? '#f59e0b' : '#3b82f6',
                fillOpacity: 1,
                weight: 2
            }).addTo(layerGroup).bindPopup(
                `Merkez: ${center[0].toFixed(5)}, ${center[1].toFixed(5)}` + 
                (isSwapped ? '<br><b class="text-amber-500">⚠ SWAPPED</b>' : '')
            );

            els.center.innerHTML = `Lat: ${center[0].toFixed(6)} <br> Lon: ${center[1].toFixed(6)}`;
        }

        function renderNeighbors(cellHex, k) {
            try {
                // Get all cells within k rings using gridDisk
                const neighborCells = h3.gridDisk(cellHex, k);

                // Count for statistics
                const totalNeighbors = neighborCells.length - 1; // Exclude center cell

                neighborCells.forEach(neighborHex => {
                    // Skip the center cell itself
                    if (neighborHex === cellHex) return;

                    try {
                        const neighborBoundary = h3.cellToBoundary(neighborHex);
                        let boundary = neighborBoundary.map(p => [...p]);

                        // Apply swap if active
                        if (isSwapped) {
                            boundary = boundary.map(p => [p[1], p[0]]);
                        }

                        // Calculate distance from center for graduated opacity
                        const distance = h3.gridDistance(cellHex, neighborHex);
                        const opacityBase = 0.15;
                        const opacityDecay = 0.02 * distance;
                        const finalOpacity = Math.max(0.05, opacityBase - opacityDecay);

                        // Render neighbor polygon with distinct styling
                        const neighborPoly = L.polygon(boundary, {
                            color: isSwapped ? '#f97316' : '#3b82f6',      // Orange or blue
                            fillColor: isSwapped ? '#f97316' : '#3b82f6',
                            fillOpacity: finalOpacity,
                            weight: 1,
                            opacity: 0.4
                        }).addTo(layerGroup);

                        // Add popup with info
                        neighborPoly.bindPopup(`
                            <div class="text-xs">
                                <b>Neighbor Cell</b><br>
                                <code class="text-[10px]">${neighborHex}</code><br>
                                <span class="text-slate-500">Distance: ${distance} ring(s)</span>
                            </div>
                        `);

                    } catch (err) {
                        console.warn(`Failed to render neighbor ${neighborHex}:`, err);
                    }
                });

                // Optional: Show neighbor count in console
                console.log(`Rendered ${totalNeighbors} neighbors at k=${k}`);

            } catch (err) {
                console.error('Error rendering neighbors:', err);
            }
        }

        function resetSwapBtn() {
            els.swapBtn.className = 'mt-3 w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded text-[10px] transition-colors border border-slate-700';
            els.swapBtn.innerHTML = `<i data-lucide="arrow-left-right" class="w-3 h-3"></i> ${i18n[currentLang].btnSwap}`;
            refreshIcons();
        }

        els.swapBtn.addEventListener('click', () => {
            isSwapped = !isSwapped;
            if (isSwapped) {
                els.swapBtn.className = 'mt-3 w-full flex items-center justify-center gap-2 bg-amber-600 hover:bg-amber-500 text-white py-2 rounded text-[10px] transition-colors border border-amber-500 shadow-lg';
                els.swapBtn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> Original';
            } else {
                resetSwapBtn();
            }
            refreshIcons();
            renderMap();
        });

        // Locate Me with AUTO Resolution
        els.locateBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                alert("Tarayıcınız konum servisini desteklemiyor.");
                return;
            }
            
            els.locateBtn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> ...';
            refreshIcons();

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    els.latInput.value = lat;
                    els.lonInput.value = lon;
                    
                    // If in Coord mode, trigger search immediately
                    if(currentMode === 'coord') {
                        visualize();
                    } else {
                        // Use Res 15 for maximum detail
                        const h3Index = h3.latLngToCell(lat, lon, 15);
                        
                        // Force HEX format for generated ID
                        currentIdFormat = 'hex';
                        document.querySelector('input[name="idFormat"][value="hex"]').checked = true;
                        
                        visualizeH3(h3Index);
                    }
                    
                    els.locateBtn.innerHTML = `<i data-lucide="crosshair" class="w-3 h-3"></i> ${i18n[currentLang].btnLocate}`;
                    refreshIcons();
                },
                (error) => {
                    console.error(error);
                    alert("Konum alınamadı. İzinleri kontrol edin.");
                    els.locateBtn.innerHTML = `<i data-lucide="crosshair" class="w-3 h-3"></i> ${i18n[currentLang].btnLocate}`;
                    refreshIcons();
                }
            );
        });

        // Map Click Listener with AUTO Resolution
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            els.latInput.value = lat.toFixed(6);
            els.lonInput.value = lng.toFixed(6);

            const currentZoom = map.getZoom();
            const targetRes = getResFromZoom(currentZoom);
            
            try {
                const cell = h3.latLngToCell(lat, lng, targetRes);
                
                // Force HEX format for map click result
                currentIdFormat = 'hex';
                document.querySelector('input[name="idFormat"][value="hex"]').checked = true;
                
                visualizeH3(cell);
            } catch(err) {
                console.error("Map click error", err);
            }
        });

        els.btn.addEventListener('click', () => visualize());
        els.searchCoordBtn.addEventListener('click', () => visualize());
        els.input.addEventListener('keypress', (e) => { if (e.key === 'Enter') visualize(); });

        window.onload = function() {
            setTimeout(() => {
                setLanguage(currentLang); // Set detected or default language
                refreshIcons(); // Refresh icons after language is set

                // Auto-load Anıtkabir at Resolution 13 on startup
                const anitkabir_lat = 39.925;
                const anitkabir_lon = 32.836944;
                const anitkabir_h3 = h3.latLngToCell(anitkabir_lat, anitkabir_lon, 11);

                // Set to hex mode and visualize
                currentIdFormat = 'hex';
                document.querySelector('input[name="idFormat"][value="hex"]').checked = true;
                visualizeH3(anitkabir_h3);
            }, 200);
        };
    </script>
</body>
</html>